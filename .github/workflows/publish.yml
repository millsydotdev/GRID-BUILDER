name: Build and Publish

on:
    push:
        tags:
            - "v*"

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: grid-editor/grid-enterprise

jobs:
    build-and-push-docker:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: type=ref,event=tag

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}

    build-cli-binaries:
        name: Build CLI Binaries
        runs-on: ubuntu-latest
        strategy:
            matrix:
                target:
                    [
                        x86_64-unknown-linux-gnu,
                        x86_64-pc-windows-msvc,
                        x86_64-apple-darwin,
                    ]
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      artifact_name: cli-linux-x64.tar.gz
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      artifact_name: cli-win32-x64.zip
                    - target: x86_64-apple-darwin
                      os: macos-latest
                      artifact_name: cli-darwin-universal.zip

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  target: ${{ matrix.target }}
                  override: true

            - name: Build CLI
              run: |
                  # Ideally call existing scripts here, ensuring cross-platform compat
                  # For example: cargo build --release --target ${{ matrix.target }}
                  echo "Building for ${{ matrix.target }}"
                  # Replace with actual build command

            - name: Upload Binaries to Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  files: |
                      target/${{ matrix.target }}/release/grid-server
                      # Add other artifacts
